(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))c(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&c(a)}).observe(document,{childList:!0,subtree:!0});function s(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function c(e){if(e.ep)return;e.ep=!0;const r=s(e);fetch(e.href,r)}})();const d=document.getElementById("app");function b(){const n=document.createElement("form");n.id="chat-form",n.className="chat-form";const t=document.createElement("input");t.id="input",t.autocomplete="off",t.placeholder="Type a message...";const s=document.createElement("button");return s.type="submit",s.textContent="Send",n.appendChild(t),n.appendChild(s),{form:n,input:t}}function w(){const n=document.createElement("ul");return n.id="messages",n.className="messages",n}function m(n,t){const s=document.getElementById("messages"),c=document.createElement("li");c.className=`message ${n}`,c.textContent=t,s.appendChild(c),s.scrollTop=s.scrollHeight}const i=w(),{form:g,input:h}=b(),p=document.createElement("div");p.className="controls";p.innerHTML='<label class="stream-toggle"><input id="stream" type="checkbox" /> Stream responses</label> <button id="clear-session" class="clear-btn" type="button">Clear history</button>';d.appendChild(document.createElement("header"));d.appendChild(i);d.appendChild(g);d.appendChild(p);const y=document.getElementById("stream"),T=document.getElementById("clear-session"),o=[];g.addEventListener("submit",async n=>{n.preventDefault();const t=h.value.trim();if(!t)return;m("user",t),o.push({role:"user",content:t}),h.value="",m("system","...");const s=document.querySelector(".system:last-child");if(!!(y&&y.checked))try{const e=await fetch("/api/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,history:o}),credentials:"include"});if(!e.ok){const l=await e.json().catch(()=>({}));s.textContent=`Error: ${l.error||e.statusText}`;return}const r=e.body.getReader(),a=new TextDecoder;let f=!1,u="";for(;!f;){const{value:l,done:E}=await r.read();if(f=E,l){const C=a.decode(l);u+=C,s.textContent=u,i.scrollTop=i.scrollHeight}}o.push({role:"assistant",content:u})}catch(e){s.textContent="Network error.",console.error(e)}else try{const r=await(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,history:o}),credentials:"include"})).json();r.error?s.textContent=`Error: ${r.error}`:(s.textContent=r.reply,o.push({role:"assistant",content:r.reply}))}catch(e){s.textContent="Network error.",console.error(e)}});T.addEventListener("click",async()=>{try{await fetch("/api/session/clear",{method:"POST",credentials:"include"}),i.innerHTML="",o.length=0}catch(n){console.warn("failed to clear session",n)}});async function x(){try{const t=await(await fetch("/api/session",{credentials:"include"})).json();t&&Array.isArray(t.history)&&(i.innerHTML="",t.history.forEach(s=>m(s.role==="user"?"user":"system",s.content)),o.length=0,t.history.forEach(s=>o.push(s)))}catch(n){console.warn("failed to load session",n)}}x();
